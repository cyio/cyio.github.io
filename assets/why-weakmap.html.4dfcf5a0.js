import{r as a,o as n,c as s,a as e,F as p,d as t,b as o}from"./app.09b8f80a.js";const c={},r=t('<h1 id="从-vuepress-构建的一个报错看-weakmap" tabindex="-1"><a class="header-anchor" href="#从-vuepress-构建的一个报错看-weakmap" aria-hidden="true">#</a> 从 VuePress 构建的一个报错看 WeakMap</h1><p>从 VuePress 2.x 构建的一个错误谈起<code>build: TypeError: Invalid value used as weak map key</code>，为什么用 WeakMap，它的 key 类型要求是什么？</p><p><img src="https://user-images.githubusercontent.com/3146103/159602294-3f150d61-e768-4765-8eb8-860fb48f7006.png" alt="vue build error"></p><h2 id="map-的实现与问题" tabindex="-1"><a class="header-anchor" href="#map-的实现与问题" aria-hidden="true">#</a> map 的实现与问题</h2><p>Map 由两个数组实现，[keys] [values]，支持遍历</p><p>理想情况，当<code>obj = null</code>时，我们希望 obj 占用空间能被自动回收</p><p>但当 obj 作为 map 的 key 时，存在强引用关系，会阻止内存回收</p><p>强引用本身也是有用的，比如通过 map.keys() 得到的值确定</p><p>解决：使用弱引用，没有引用时，可被垃圾回收</p><h2 id="与-map-不同点" tabindex="-1"><a class="header-anchor" href="#与-map-不同点" aria-hidden="true">#</a> 与 map 不同点</h2><ol><li>weakmap 的 key 只能是 object，如果使用原始类型，会抛错。原因可能是它的存在只是为了补充 map</li><li>由于弱引用，无法保证 key 存在，不支持遍历相关方法</li></ol><h2 id="使用场景" tabindex="-1"><a class="header-anchor" href="#使用场景" aria-hidden="true">#</a> 使用场景：</h2><ol><li>额外数据，比如 value 的读取依赖 key，key 如不存在了，value 也不再可访问。</li><li>缓存</li></ol><p>weakset 类似，只能存 object，不支持遍历相关方法</p><p>回到文章开头，由于在 md 文件中存在的标签<code>&lt;Hello /&gt;</code>，不是 Vue 组件、或未经注册，Vue WeakMap 接收的 key 本应是组件对象，变成了 string 引发错误。</p><p>构建抛错程序会中止，把组件参数打印出来，最后的打印输出就是有问题的标签，将 md 中相应标签处理即可解决。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>raw <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasExtends<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;debug&#39;</span><span class="token punctuation">,</span> comp<span class="token punctuation">)</span> <span class="token comment">// </span>\n    cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>comp<span class="token punctuation">,</span> shared<span class="token punctuation">.</span><span class="token constant">EMPTY_ARR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> shared<span class="token punctuation">.</span><span class="token constant">EMPTY_ARR</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当然，更完善做法，主动在 WeakMap 入参增加校验，类型不满足时将参数输出。</p>',18),l={href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap",target:"_blank",rel:"noopener noreferrer"},u=o("WeakMap - JavaScript | MDN"),i={href:"https://javascript.info/weakmap-weakset",target:"_blank",rel:"noopener noreferrer"},k=o("WeakMap and WeakSet");c.render=function(t,o){const c=a("OutboundLink");return n(),s(p,null,[r,e("p",null,[e("a",l,[u,e(c)]),e("a",i,[k,e(c)])])],64)};export default c;
