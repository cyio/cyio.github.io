(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{489:function(e,t,a){"use strict";a.r(t);var r=a(56),s=Object(r.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"vue-3-源码学习"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vue-3-源码学习"}},[e._v("#")]),e._v(" Vue 3 源码学习")]),e._v(" "),a("p",[e._v("[toc]")]),e._v(" "),a("h2",{attrs:{id:"调试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调试"}},[e._v("#")]),e._v(" 调试")]),e._v(" "),a("p",[e._v("git clone git@github.com:vuejs/core.git vue3-core")]),e._v(" "),a("h2",{attrs:{id:"目录结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#目录结构"}},[e._v("#")]),e._v(" 目录结构")]),e._v(" "),a("p",[e._v("packages")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v(".\n├── compiler-core // 编译核心，抽象语法树和渲染桥接实现\n├── compiler-dom // Dom 实现\n├── compiler-sfc // SFC 单文件组件(.vue)的实现\n├── compiler-ssr\n├── global.d.ts\n├── reactivity // 响应式\n├── runtime-core\n├── runtime-dom\n├── runtime-test\n├── server-renderer // 服务端渲染实现\n├── shared  // package 之间共享的工具库\n├── size-check\n├── template-explorer\n└── vue // 入口？\n")])])]),a("p",[e._v("compiler、runtime 概念区别\ncompiler 源码到可执行代码，runtime 程序运行时")]),e._v(" "),a("h2",{attrs:{id:"模块关系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模块关系"}},[e._v("#")]),e._v(" 模块关系")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("vue - packages/vue/src/index.ts\n    @vue/compiler-dom\n        @vue/compiler-core\n    @vue/runtime-dom\n        @vue/runtime-core\n")])])]),a("h2",{attrs:{id:"createapp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#createapp"}},[e._v("#")]),e._v(" createApp")]),e._v(" "),a("p",[e._v("方法关系：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("createRenderer\n baseCreateRenderer\n   createAppAPI\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("// packages/runtime-core/src/renderer.ts\nfunction baseCreateRenderer\n  ...\n  return {\n    render,\n    hydrate,\n    createApp: createAppAPI(render, hydrate)\n  }\n")])])]),a("p",[e._v("createAppAPI")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("app\n  use(plugin: Plugin, ...options: any[]) {\n  mixin(mixin: ComponentOptions) {\n  component(name: string, component?: Component): any {\n  directive(name: string, directive?: Directive) {\n\n  mount(\n  unmount() {\n  provide(key, value) {\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("propsCache: new WeakMap(),\n")])])]),a("h2",{attrs:{id:"core-api-runtime"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#core-api-runtime"}},[e._v("#")]),e._v(" core api - runtime")]),e._v(" "),a("p",[a("code",[e._v("packages/runtime-core/src/index.ts")]),e._v("负责将最常用方法、API 导出")]),e._v(" "),a("p",[e._v("defineComponent 类型 util")]),e._v(" "),a("p",[e._v("h - Hyperscript 参数判断，实际调用 createVNode")]),e._v(" "),a("p",[e._v("v-if/v-for 视为 block，可能动态变更")]),e._v(" "),a("h2",{attrs:{id:"reactive"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#reactive"}},[e._v("#")]),e._v(" reactive")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c884b48e88a643e2b695b3587224b51d~tplv-k3u1fbpfcp-watermark.awebp",alt:"reactive 工作流程"}})]),e._v(" "),a("p",[e._v("文件结构")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("└── src\n    ├── baseHandlers.ts // 基本类型的处理器\n    ├── collectionHandlers.ts  // Set Map WeakSet WeckMap的处理器\n    ├── computed.ts // 计算属性，同Vue2\n    ├── deferredComputed.ts // 计算属性\n    ├── dep.ts // \n    ├── effect.ts // reactive 核心，处理依赖收集，依赖更新\n    ├── effectScope.ts // \n    ├── index.ts\n    ├── operations.ts // 定义依赖收集，依赖更新的类型\n    ├── reactive.ts // reactive 入口，内部主要以 Proxy 实现\n    └── ref.ts // Proxy 处理不了值类型的响应，Ref 来处理\n")])])]),a("p",[e._v("ref 实现")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("ref( 默认深拷贝\n  createRef(\n    RefImpl(\n      toReactive 对象调用 reactive，非对象直接返回\n         sObject(value) ? reactive(value) : value\n            createReactiveObject(mutableHandlers\n                new Proxy\n      get 时，触发依赖收集、追踪\n        trackEffects\n      set 时，触发依赖更新\n        triggerEffects\n")])])]),a("blockquote",[a("p",[e._v("官方文档：如果传入 ref 的是一个对象，将调用 reactive 方法进行深层响应转换。")])]),e._v(" "),a("p",[e._v("effect 作为 reactive 的核心，主要负责监听响应式数据的变化，触发监听函数的执行逻辑")]),e._v(" "),a("blockquote",[a("p",[e._v("Vue 最独特的特性之一，是其非侵入性的响应性系统。数据模型是被代理的 JavaScript 对象。")])]),e._v(" "),a("p",[e._v("原始类型响应式解决方案，转换成对象，增加"),a("code",[e._v(".value")]),e._v("，模板访问时自动解套")]),e._v(" "),a("p",[e._v("targetMap 记录 target object/property 和 effect 关系，二层数据结构：")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("weakmap "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    targetObject"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" map "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        targetProperty"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" dep"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("effect array"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),a("p",[e._v("effectStack "),a("code",[e._v("push -> run -> pop")])]),e._v(" "),a("p",[e._v("activeEffect 当前运行的 effect")]),e._v(" "),a("p",[e._v("记录依赖关系时，查询 activeEffect")]),e._v(" "),a("p",[e._v("setupResult 是 setup return 的对象")]),e._v(" "),a("h2",{attrs:{id:"讨论点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#讨论点"}},[e._v("#")]),e._v(" 讨论点")]),e._v(" "),a("p",[e._v("数据和逻辑聚合")]),e._v(" "),a("p",[e._v("以功能或者职责来组织文件")]),e._v(" "),a("p",[e._v("新的 API 理论上会降低代码质量的最低门槛")]),e._v(" "),a("p",[e._v("setup 作用是为了合成生成物，供外部访问 https://stackoverflow.com/a/58500917")]),e._v(" "),a("h2",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[e._v("#")]),e._v(" 参考")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://v3.cn.vuejs.org/guide/reactivity.html#%25E4%25BB%2580%25E4%25B9%2588%25E6%2598%25AF%25E5%2593%258D%25E5%25BA%2594%25E6%2580%25A7",target:"_blank",rel:"noopener noreferrer"}},[e._v("深入响应性原理 | Vue.js"),a("OutboundLink")],1),e._v(" "),a("a",{attrs:{href:"https://segmentfault.com/a/1190000039691166",target:"_blank",rel:"noopener noreferrer"}},[e._v("推荐 7 个 Vue2、Vue3 源码解密分析的重磅开源项目 👍 - SegmentFault 思否"),a("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=s.exports}}]);